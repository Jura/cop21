<!doctype html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COP21 quotes</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/5.5.3/css/foundation.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.5.8/slick.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.5.8/slick-theme.min.css" />
  <style>
    .hero {
      height: 100vh;
      overflow: hidden;
    }
    #map {
      height: 100%;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
</head>

<body>

  <div class="hero">
    <div id="map"></div>
  </div>
  
  <div id="slideshow" class="reveal-modal medium" data-reveal aria-labelledby="slideshow-title" aria-hidden="true" role="dialog">
    <h2 id="slideshow-title"></h2>
    <div id="slideshow-content"></div>
    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation-essential/5.5.3/js/foundation.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.5.8/slick.min.js"></script>
  
  <script>
    $(document).foundation();
    var $slideshow = $('#slideshow-content').slick({
      appendArrows: '#slideshow',
      autoplay: false,
      dots: true,
      //appendDots: '#slideshow',
      infinite: false
    });
    $(document).on('opened.fndtn.reveal', function () {
      $slideshow.slick("setPosition", 0);
    });
    
    var map = L.map('map').setView([0, 35], 3);
    
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: '© <a href="https://www.mapbox.com/map-feedback/" target="_blank">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap contributors</a>',
        maxZoom: 10,
        id: 'undporg.cig9rbehw004tuekrnt5bf253',
        accessToken: 'pk.eyJ1IjoidW5kcG9yZyIsImEiOiJjaWc5cmJmcWwwMDRxdjJrcjgxbnczaThvIn0.J-5uk4LED0EgvK1raqCJmg'
    }).addTo(map);
    
    $.getJSON('centroids.json').done(function(data){
      
      var widthMax = data.reduce(function(max, arr) {
          return max >= arr[1] ? max : arr[1];
      }, -Infinity);
      var widthMin = data.reduce(function(min, arr) {
          return arr[1] < min ? arr[1] : min;
      }, Infinity);
      
      var radius = 0, markers = [];
      //Marker radius should fall between 3 and 50 pixels
      var radius = Math.ceil(widthMax/50);
      for (var i=0; i<data.length; i++) {
        // add circle markers
        markers.push(
          new L.circleMarker([data[i][2],data[i][3]], {weight:2, data: data[i]})
                            .setRadius(Math.round(data[i][1]/radius) + 3)
                            .on('click', showpopup)
        );
      }
      var cLayer = L.layerGroup(markers).addTo(map);
    });
    
    var loaded = {};
    
    function showpopup(e) {
      var country = e.target.options.data[0];
      
      // get quotes if not cached already
      if (typeof loaded[country] == 'undefined') {
        var apiUrl = 'https://www.googleapis.com/fusiontables/v2/query'; // Google Fusion Table API endpoint
        var datasource = '1MR__Aal85XmQchYSpakuA3Ol3tyO4Py4BMoHkkWh'; // ID of the Fusion Table we are pulling data from
        var sql = 'SELECT answer FROM ' + datasource + ' WHERE country = \'' + country + '\' AND answer NOT EQUAL TO \'\'';
        var key = 'AIzaSyCu3LqZDIDAj5f7uWzIJaI0BESvOxuAuUg'; // Google API key used for requests attribution
        $.getJSON(apiUrl, {sql: sql, key: key}).done(function(data){
          shuffle(data.rows);
          loaded[country] = data.rows;
          showSlides(country);
        });
      } else {
        showSlides(country);
      }      
    }
    
    function showSlides(country) {
      for (var i=0; i<loaded[country].length; i++) {
        $slideshow.slick('slickAdd', '<div data-country="' + country + '">' + loaded[country][i][0] + '</div>');
      }
      $('#slideshow-title').text(country);
      $slideshow.slick('slickFilter', '[data-country="' + country + '"]');
      $('#slideshow').foundation('reveal', 'open');      
    }
    
    // from http://stackoverflow.com/a/2450976/537584
    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex ;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }
  </script>
</body>
</html>